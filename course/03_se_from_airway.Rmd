---
title: "03 SummarizedExperiment: airway_small"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, fig.width = 7, fig.height = 4.5)
suppressPackageStartupMessages({
  library(readr); library(dplyr); library(tidyr); library(tibble)
  library(SummarizedExperiment); library(S4Vectors)
})
counts_path <- "~/r-gx-tutorial/data/processed/airway_counts_small.csv"
meta_path   <- "~/r-gx-tutorial/data/processed/airway_meta_small.csv"
```


## Load counts and sample metadata

```{r load-data}
cts_tbl <- readr::read_csv(counts_path, show_col_types = FALSE)
meta_tbl <- readr::read_csv(meta_path, show_col_types = FALSE)

# Detect feature (row) column: prefer 'gene' if present, otherwise last column
feature_col <- if ("gene" %in% names(cts_tbl)) "gene" else tail(names(cts_tbl), 1)
sample_cols <- setdiff(names(cts_tbl), feature_col)

# Peek
dplyr::glimpse(cts_tbl)
dplyr::glimpse(meta_tbl)

# Ensure sample_id column in meta and reorder to match counts
stopifnot("sample_id" %in% names(meta_tbl))
meta_tbl <- meta_tbl |>
  mutate(sample_id = as.character(sample_id)) |>
  slice(match(sample_cols, sample_id))

# Build counts matrix with gene as rownames and samples as columns
cts_mat <- cts_tbl |>
  relocate(all_of(feature_col), .before = 1) |>
  column_to_rownames(var = feature_col) |>
  as.matrix()

# Coerce to integer storage
storage.mode(cts_mat) <- "integer"

# Sanity checks
stopifnot(all(colnames(cts_mat) == meta_tbl$sample_id))
dim(cts_mat)
head(cts_mat[, 1:min(4, ncol(cts_mat))])
```


## Construct a SummarizedExperiment

```{r make-se}
col_data <- S4Vectors::DataFrame(meta_tbl)
se <- SummarizedExperiment::SummarizedExperiment(
  assays = list(counts = cts_mat),
  colData = col_data
)
se
```


## Basic QC summaries

```{r qc}
libsizes <- colSums(assay(se, "counts"))
data.frame(sample = colnames(se), library_size = libsizes) |>
  arrange(desc(library_size))
summary(libsizes)
```


## Save object

```{r save}
out_rds <- "~/r-gx-tutorial/data/processed/airway_se_small.rds"
saveRDS(se, out_rds)
out_rds
```

